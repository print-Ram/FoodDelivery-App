<div class="coupon-container">

  <h2 *ngIf="isAdmin">Admin Coupon Management</h2>
  <h2 *ngIf="!isAdmin">Available Coupons</h2>

  <div class="message" *ngIf="message">{{ message }}</div>

  <!-- ================= ADMIN SECTION ================= -->
  <div *ngIf="isAdmin" class="admin-section">

    <!-- CREATE COUPON FORM -->
    <div class="form-box">

      <div class="row">
        <div class="col-md-3 mb-2">
          <input type="text"
                 class="form-control"
                 placeholder="Coupon Code"
                 [(ngModel)]="newCoupon.code"
                 name="newCode">
        </div>

        <div class="col-md-3 mb-2">
          <input type="number"
                 class="form-control"
                 placeholder="Discount (₹ or %)"
                 [(ngModel)]="newCoupon.discount"
                 name="newDiscount">
        </div>
        <!-- Nth Order (optional) -->
        <div class="mb-3">
          <label class="form-label">Nth Order (optional)</label>
          <input type="number"
              class="form-control"
              [(ngModel)]="newCoupon.nthOrder"
              name="newNthOrder"
              placeholder="e.g. 5 for 5th order">
        </div>

        <div class="col-md-6 mb-2">
          <label class="form-label small">Product (optional – make coupon product-specific)</label>
          <select class="form-select"
                  [(ngModel)]="newCoupon.productId"
                  name="newProductId">
            <option value="">All products</option>
            <option *ngFor="let p of products" [value]="p.product_id">
              {{ p.name }} - ₹{{ p.price }}
            </option>
          </select>
        </div>

        <div class="col-md-4 mb-2">
          <input type="text"
                 class="form-control"
                 placeholder="Description"
                 [(ngModel)]="newCoupon.description"
                 name="newDescription">
        </div>

        <div class="col-md-2 mb-2 d-grid">
          <button class="btn btn-primary" (click)="addCoupon()">Add Coupon</button>
        </div>
      </div>
    </div>

    <!-- COUPONS TABLE -->
    <div class="table-responsive mt-4">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Code</th>
            <th>Discount</th>
            <th>Description</th>
            <th>Product</th>
            <th>Nth Order</th>
            <th>Active</th>
            <th style="width: 170px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of coupons">

            <!-- Code -->
            <td *ngIf="!editingCoupon || editingCoupon.id !== c.id">
              {{ c.code }}
            </td>
            <td *ngIf="editingCoupon && editingCoupon.id === c.id">
              <input class="form-control" [(ngModel)]="editingCoupon.code" name="editCode">
            </td>

            <!-- Discount -->
            <td *ngIf="!editingCoupon || editingCoupon.id !== c.id">
              {{ c.discount }}
            </td>
            <td *ngIf="editingCoupon && editingCoupon.id === c.id">
              <input type="number"
                     class="form-control"
                     [(ngModel)]="editingCoupon.discount"
                     name="editDiscount">
            </td>

            <!-- Description -->
            <td *ngIf="!editingCoupon || editingCoupon.id !== c.id">
              {{ c.description }}
            </td>
            <td *ngIf="editingCoupon && editingCoupon.id === c.id">
              <input class="form-control"
                     [(ngModel)]="editingCoupon.description"
                     name="editDescription">
            </td>

            <!-- Product -->
            <td *ngIf="!editingCoupon || editingCoupon.id !== c.id">
              <span *ngIf="c.productId; else allProducts">
                {{ c.productId }}
              </span>
              <ng-template #allProducts>
                <span class="text-muted">All</span>
              </ng-template>
            </td>
            <td *ngIf="editingCoupon && editingCoupon.id === c.id">
              <select class="form-select"
                      [(ngModel)]="editingCoupon.productId"
                      name="editProductId">
                <option value="">All products</option>
                <option *ngFor="let p of products" [value]="p.product_id">
                  {{ p.name }} - ₹{{ p.price }}
                </option>
              </select>
            </td>

            <!-- Nth Order -->
            <td *ngIf="!editingCoupon || editingCoupon.id !== c.id">
              <span *ngIf="c.nthOrder; else anyOrder">
                {{ c.nthOrder }}
              </span>
              <ng-template #anyOrder>
                <span class="text-muted">Any</span>
              </ng-template>
            </td>
            <td *ngIf="editingCoupon && editingCoupon.id === c.id">
              <input type="number"
                     class="form-control"
                     [(ngModel)]="editingCoupon.nthOrder"
                     name="editNthOrder">
            </td>

            <!-- Active -->
            <td>
              <!-- VIEW MODE -->
              <input type="checkbox"
                     [(ngModel)]="c.active"
                     disabled
                     *ngIf="!editingCoupon || editingCoupon.id !== c.id">

              <!-- EDIT MODE -->
              <input type="checkbox"
                     [(ngModel)]="editingCoupon.active"
                     *ngIf="editingCoupon && editingCoupon.id === c.id">
            </td>

            <!-- Actions -->
            <td>
              <ng-container *ngIf="!editingCoupon || editingCoupon.id !== c.id">
                <button class="btn btn-sm btn-outline-primary" (click)="editCoupon(c)">Edit</button>
                &nbsp;
                <button class="btn btn-sm btn-outline-danger" (click)="deleteCoupon(c.id)">Delete</button>
              </ng-container>
              <ng-container *ngIf="editingCoupon && editingCoupon.id === c.id">
                <button class="btn btn-sm btn-success" (click)="updateCoupon()">Save</button>
                &nbsp;
                <button class="btn btn-sm btn-secondary" (click)="editingCoupon = null">Cancel</button>
              </ng-container>
            </td>

          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- ================= USER SECTION ================= -->
  <div *ngIf="!isAdmin" class="user-section">

    <!-- Apply coupon -->
    <div class="apply-box mt-3">
      <input type="text"
             class="form-control"
             placeholder="Enter Coupon Code"
             [(ngModel)]="applyCode"
             name="applyCode">
      <button class="btn btn-primary mt-2" (click)="applyUserCoupon()">Apply</button>
    </div>

    <!-- Ghost text list of available coupons -->
<div class="mt-3 p-2" *ngIf="coupons.length > 0">
  <p class="text-secondary small fw-semibold mb-1">List of available coupons:</p>

  <div *ngFor="let c of coupons" class="text-muted small mb-1">
    • Use <strong>%{{ c.code }}%</strong> to avail 
      <strong>{{ c.discount }}</strong>
      exclusively for <em>{{ c.description }}</em>
      <span *ngIf="c.nthOrder"> (valid on your {{ c.nthOrder }}<sup>th</sup> order)</span>
      <span *ngIf="c.productId"> (applicable only to a specific product)</span>.
  </div>
</div>


    <div *ngIf="appliedCoupon" class="applied mt-2">
      ✅ Applied: {{ appliedCoupon.code }} ({{ appliedCoupon.discount }} OFF)
    </div>
  </div>

</div>
